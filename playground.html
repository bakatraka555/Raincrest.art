<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° Raincrest Playground v1.1</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-color: #050505;
            --card-bg: #111111;
            --accent-gold: #c9a227;
            --accent-gold-dim: rgba(201, 162, 39, 0.2);
            --text-main: #f0f0f0;
            --text-muted: #888;
            --border-color: #333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            padding: 20px;
            min-height: 100vh;
        }

        h1,
        h2,
        h3 {
            font-family: 'Cinzel', serif;
            color: var(--accent-gold);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 30px;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        /* --- CARDS --- */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 10px;
        }

        .zone-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
            font-weight: 600;
        }

        /* --- FORMS --- */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        select,
        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: white;
            font-family: 'Inter', sans-serif;
        }

        textarea {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }

        input[type="file"] {
            width: 100%;
            padding: 40px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
        }

        input[type="file"]:hover {
            border-color: var(--accent-gold);
        }

        /* --- BUTTONS --- */
        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #8b7019 0%, var(--accent-gold) 100%);
            color: black;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
            font-family: 'Cinzel', serif;
            text-transform: uppercase;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(201, 162, 39, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #333;
            color: white;
            margin-top: 10px;
        }

        /* --- PREVIEWS --- */
        .preview-area {
            min-height: 200px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid var(--border-color);
            position: relative;
        }

        .preview-area img,
        .preview-area video {
            max-width: 100%;
            max-height: 400px;
        }

        /* --- RADIO SELECTOR --- */
        .radio-group {
            display: flex;
            gap: 15px;
        }

        .radio-option {
            flex: 1;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 0.9rem;
        }

        .radio-option.selected {
            border-color: var(--accent-gold);
            background: var(--accent-gold-dim);
            color: white;
        }

        /* --- LOGS --- */
        #console-log {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            border: 1px solid #333;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-ready {
            background: #22c55e;
            color: black;
        }

        .status-working {
            background: #eab308;
            color: black;
            animation: pulse 1s infinite;
        }

        .status-error {
            background: #ef4444;
            color: white;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
</head>

<body>

    <div class="header">
        <h1>‚ö° Raincrest Playground v1.1</h1>
        <p style="color: #666;">Modular Test Environment | Manual Override Enabled</p>
    </div>

    <div class="container">

        <!-- LEFT COLUMN: INPUTS & IMAGE GEN -->
        <div class="col-left">

            <!-- ZONE A: IMAGE LAB -->
            <div class="card">
                <div class="card-header">
                    <h3>üß¨ Zone A: Image Lab</h3>
                    <span class="zone-label" id="zoneA-model-label">Gemini 3 Pro (img2img)</span>
                </div>

                <!-- MODE TOGGLE -->
                <div class="form-group">
                    <label>Generation Mode</label>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn selected" id="mode-gemini" onclick="setImageMode('gemini')"
                            style="flex: 1; padding: 12px;">
                            üîÑ Gemini (img2img)<br><small style="color: #4ade80;">FREE</small>
                        </button>
                        <button type="button" class="btn" id="mode-imagen3" onclick="setImageMode('imagen3')"
                            style="flex: 1; padding: 12px;">
                            ‚ú® Imagen 3 (txt2img)<br><small style="color: #fbbf24;">$0.03/img</small>
                        </button>
                    </div>
                </div>

                <!-- GEMINI MODE: Image Upload Section -->
                <div id="gemini-section">
                    <div class="form-group">
                        <label>Reference Image (User)</label>
                        <input type="file" id="zoneA-upload" accept="image/*">
                    </div>
                </div>

                <!-- IMAGEN 3 MODE: Number of Images -->
                <div id="imagen3-section" style="display: none;">
                    <div class="form-group">
                        <label>Number of Images</label>
                        <select id="zoneA-num-images">
                            <option value="1" selected>1 image ($0.03)</option>
                            <option value="2">2 images ($0.06)</option>
                            <option value="3">3 images ($0.09)</option>
                            <option value="4">4 images ($0.12)</option>
                        </select>
                    </div>
                    <div
                        style="background: #3b2f0a; border: 1px solid #fbbf24; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                        <span style="color: #fbbf24;">‚ö†Ô∏è Imagen 3 is NOT free - $0.03 per image</span>
                    </div>
                </div>

                <div class="form-group" id="template-section">
                    <label>Template Logic</label>
                    <select id="zoneA-template" onchange="updatePromptPreview()">
                        <option value="template-01">Trading Card (Epic)</option>
                        <option value="template-02" selected>Dragon Rider (Cinematic)</option>
                        <option value="template-03">Bobblehead (Cartoon)</option>
                        <option value="template-09">Iron Throne Ruler (King/Queen)</option>
                        <option value="template-10">Night Watch (The Wall)</option>
                        <option value="template-11">White Walker General (Ice)</option>
                        <option value="template-12">Dothraki Warlord (Open Field)</option>
                        <option value="template-13">Mother/Father of Dragons (Targaryen)</option>
                        <option value="template-14">Westeros Trading Card (Sellsword)</option>
                        <option value="custom">‚ú® CUSTOM (Write your own)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Image Prompt (EDITABLE)</label>
                    <textarea id="zoneA-prompt-preview" rows="8"
                        style="color: #fff; background: #222;">Select a template to see logic...</textarea>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">*You can edit this! The AI will use
                        exactly what you type here.*</div>
                </div>

                <div class="form-group">
                    <label>Aspect Ratio</label>
                    <select id="zoneA-aspect-ratio">
                        <option value="9:16" selected>üì± 9:16 (Portrait - Social Media)</option>
                        <option value="1:1">‚¨ú 1:1 (Square - Instagram)</option>
                        <option value="16:9">üñ•Ô∏è 16:9 (Landscape - Desktop)</option>
                        <option value="4:5">üì∏ 4:5 (Portrait - Instagram Feed)</option>
                        <option value="4:3">üì∫ 4:3 (Classic)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Resolution</label>
                    <select id="zoneA-resolution">
                        <option value="1K">1K (Fast)</option>
                        <option value="2K" selected>2K (Balanced)</option>
                        <option value="4K">4K (High Quality)</option>
                    </select>
                </div>

                <div class="form-group" style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <label>Output Format</label>
                        <select id="zoneA-format" style="width: 100%;">
                            <option value="png" selected>PNG (Best Quality)</option>
                            <option value="jpeg">JPEG (Smaller File)</option>
                            <option value="webp">WebP (Web Optimized)</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label>Safety Filter</label>
                        <select id="zoneA-safety" style="width: 100%;">
                            <option value="block_only_high" selected>Standard</option>
                            <option value="block_medium_and_above">Strict</option>
                            <option value="block_none">Off (Adults Only)</option>
                        </select>
                    </div>
                </div>

                <div
                    style="background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 10px; margin-bottom: 15px; text-align: center;">
                    <span style="color: #4ade80; font-weight: bold;">üÜì FREE API</span>
                    <span style="color: #888;"> - gemini-3-pro-image-preview (Google AI)</span>
                </div>

                <button class="btn" id="zoneA-btn" onclick="generateImage()">
                    Generate Base Image üé®
                </button>

                <!-- RESULT A -->
                <div class="preview-area" id="zoneA-result" style="margin-top: 20px;">
                    <p class="text-muted">Image will appear here</p>
                </div>
            </div>

            <!-- LOGS -->
            <div class="card">
                <div class="card-header">
                    <h3>üìü System Logs</h3>
                </div>
                <div id="console-log"></div>
            </div>

        </div>

        <!-- RIGHT COLUMN: VIDEO ARENA -->
        <div class="col-right">

            <!-- ZONE B: VIDEO ARENA -->
            <div class="card">
                <div class="card-header">
                    <h3>‚öîÔ∏è Zone B: Video Arena</h3>
                    <span class="zone-label">Kling vs Veo</span>
                </div>

                <div class="form-group">
                    <label>Source Image URL</label>
                    <input type="text" id="zoneB-source-url" placeholder="https://...">
                </div>

                <div class="form-group">
                    <label>Video Prompt (Editable)</label>
                    <textarea id="zoneB-prompt"
                        rows="3">Cinematic slow motion, dragon breathing fire, epic lighting, 4k.</textarea>
                    <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">*Defaults to standard loop description.
                        Change to test creativity.*</p>
                </div>

                <div class="form-group">
                    <label>Veo Model Version</label>
                    <div class="radio-group" id="veo-model-select">
                        <div class="radio-option selected" onclick="selectVeoModel('standard')" id="veo-opt-standard">
                            Standard (v3.1)</div>
                        <div class="radio-option" onclick="selectVeoModel('fast')" id="veo-opt-fast">Fast (Preview)
                        </div>
                    </div>
                    <input type="hidden" id="veo-model-val" value="standard">
                </div>

                <div class="form-group">
                    <label>Launch Generation</label>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" style="background: linear-gradient(135deg, #4b5563, #1f2937);"
                            onclick="generateVideo('kling')">KLING v1</button>
                        <button class="btn" style="background: linear-gradient(135deg, #7c3aed, #4c1d95);"
                            onclick="generateVideo('veo')">VEO 3.1</button>
                    </div>
                </div>

                <!-- RESULT B -->
                <div class="preview-area" id="zoneB-result" style="margin-top: 20px; min-height: 300px;">
                    <p class="text-muted">Video result will appear here</p>
                </div>
            </div>

        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // =====================================================================
        // API CONFIGURATION
        // Set API_BASE to production so Playground uses LIVE Netlify functions
        // (which have access to all env vars) instead of local dev server.
        // To test locally: change to '' (empty string)
        // =====================================================================
        const API_BASE = 'https://raincrest-art.netlify.app';  // <-- PRODUCTION MODE
        // const API_BASE = '';  // <-- LOCAL MODE (uncomment for local dev)

        // GLOBALS
        let currentImageBlob = null;
        let generatedImageUrl = null;
        let currentImageMode = 'gemini'; // 'gemini' or 'imagen3'

        // MODE SWITCHING
        function setImageMode(mode) {
            currentImageMode = mode;

            // Update button styles
            document.getElementById('mode-gemini').classList.toggle('selected', mode === 'gemini');
            document.getElementById('mode-imagen3').classList.toggle('selected', mode === 'imagen3');

            // Show/hide relevant sections
            document.getElementById('gemini-section').style.display = mode === 'gemini' ? 'block' : 'none';
            document.getElementById('imagen3-section').style.display = mode === 'imagen3' ? 'block' : 'none';
            document.getElementById('template-section').style.display = mode === 'gemini' ? 'block' : 'none';

            // Update label
            const label = document.getElementById('zoneA-model-label');
            label.textContent = mode === 'gemini' ? 'Gemini 3 Pro (img2img) - FREE' : 'Imagen 3 (txt2img) - $0.03/img';
            label.style.color = mode === 'gemini' ? '#4ade80' : '#fbbf24';

            // Update button text
            const btn = document.getElementById('zoneA-btn');
            btn.textContent = mode === 'gemini' ? 'Generate Base Image üé®' : 'Generate with Imagen 3 ‚ú®';

            // Update prompt placeholder for Imagen 3
            const promptBox = document.getElementById('zoneA-prompt-preview');
            if (mode === 'imagen3') {
                promptBox.placeholder = 'Describe the image you want to generate... Be detailed about style, lighting, composition.';
                if (promptBox.value.startsWith('SCENE:')) {
                    promptBox.value = 'A photorealistic portrait of a medieval dragon rider, dramatic lighting, cinematic composition, 8k quality';
                }
            }

            log(`Mode switched to: ${mode === 'gemini' ? 'Gemini (FREE)' : 'Imagen 3 ($0.03/img)'}`, 'info');
        }

        // FULL DETAILED PROMPTS (from prompts.js)
        const TEMPLATE_PREVIEWS = {
            'template-01': `SCENE: A high-fidelity cinematographic shot of a medieval King and Queen breaking through the fourth wall of a magical trading card.
LOCATION: Dubrovnik Old Town, reimagined in a dark fantasy medieval era. No modern elements.
STYLE: Game of Thrones aesthetic, 8k resolution, dramatic volumetric lighting.
SPECIAL: Ensure the "Raincrest" text at the top of the card is legible and metallic. The characters should look powerful and realistic, not cartoonish. The dragon in the background should be breathing fire towards the viewer.`,

            'template-02': `SCENE: An epic wide shot of a dragon rider flying over medieval Dubrovnik at sunset.
LOCATION: Aerial view of Dubrovnik walls and the Adriatic sea. Historical wooden ships in the harbor.
STYLE: Cinematic fantasy realism, golden hour lighting, hyper-detailed dragon scales.
SPECIAL: The dragon must be breathing fire FORWARD. The rider sits securely on the dragon's back. IMPORTANT: The fire should NOT obscure the rider's face. The rider looks confident and heroic.`,

            'template-03': `SCENE: A playful 3D-rendered caricature of a couple riding a cute but epic dragon.
LOCATION: Stylized miniature version of Dubrovnik.
STYLE: Pixar-style animation, vibrant colors, exaggerated head proportions (bobblehead).
SPECIAL: Characters have large heads and small bodies. Expressions should be joyful and excited. The dragon looks friendly but impressive. Bright, warm lighting.`,

            'template-09': `SCENE: The character sitting powerfully on the Iron Throne in the Great Hall of the Red Keep.
LOCATION: King's Landing, inside the Throne Room, swords, torches, massive columns.
STYLE: Game of Thrones cinematic, dark moody lighting, royal, intimidating, high contrast.
SPECIAL: Sitting on the Iron Throne. Wearing royal armor/crown. Looking powerful and slightly dangerous. Lighting shafts from high windows.`,

            'template-10': `SCENE: Standing atop the massive Ice Wall looking out into the dark North.
LOCATION: The Wall, Castle Black, snow, ice, dark forest in distance, blue cold atmosphere.
STYLE: Cinematic fantasy, cold palette (blues and whites), gritty realism, snow particles.
SPECIAL: Wearing heavy black fur cloak (Night Watch style). Snow falling. Grim and determined expression. Holding a sword or lantern.`,

            'template-11': `SCENE: Transformed into a White Walker general leading an army of the dead.
LOCATION: Beyond the Wall, blizzard, icy wasteland, glowing blue magic eyes.
STYLE: Dark fantasy horror, cold blue tones, glowing eyes, crystalline ice armor.
SPECIAL: Skin is pale/icy texture. Eyes glowing bright blue. Wearing armor made of ice. Aura of cold mist. Intimidating and supernatural.`,

            'template-12': `SCENE: Riding a horse in the open grass sea, shouting a battle cry.
LOCATION: The Dothraki Sea, open plains, golden grass, blue sky, fire pit in background.
STYLE: Epic adventure, warm earth tones, dusty, savage beauty, dynamic motion.
SPECIAL: Wearing leather tribal gear and war paint. Muscular and wild appearance. Riding a horse (or standing next to one).`,

            'template-13': `SCENE: Standing majestically with three small baby dragons climbing on shoulders/arms.
LOCATION: Dragonstone throne room or volcanic cliffs, dramatic coastline.
STYLE: High fantasy, Targaryen red and black, mystical, regal.
SPECIAL: Platinum blonde hair (optional/silver wig style). Wearing Targaryen colors (black/red). Three small dragons interacting (one on shoulder, one in hand).`,

            'template-14': `SCENE: An ultra-photorealistic, gritty cinematic dark fantasy illustration depicting a hardened adventurer/sellsword dynamically bursting through the frame of an ancient trading card.
LOCATION: Dubrovnik doubling as King's Landing, Red Keep in background.
STYLE: Ultra-photorealistic, gritty cinematic dark fantasy, dramatic golden-hour lighting.
SPECIAL: Bursting through stone border. Debris flying. Action pose. Background is King's Landing (Dubrovnik).`,

            'custom': 'Write your own prompt here... describe the scene, location, style, and special instructions.'
        };
        // FILE HANDLING & COMPRESSION
        // ---------------------------------------------------------

        document.getElementById('zoneA-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Preview immediately
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('zoneA-result').innerHTML = `<img src="${e.target.result}" style="opacity: 0.5">`;
            };
            reader.readAsDataURL(file);

            log(`File selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);

            // SMART STRATEGY: 
            // 1. If < 5MB, upload original directly (No compression).
            // 2. If > 5MB, convert to High-Quality JPEG (95%) to reduce size without resizing dimensions.
            // This preserves 100% of facial resolution.

            let fileToUpload = file;
            if (file.size > 5 * 1024 * 1024) { // > 5MB
                log('Image > 5MB. Converting to High-Quality JPEG (Lossless-like)...', 'warning');
                try {
                    // Compress with 0.95 quality, keep MAX resolution (4000px)
                    fileToUpload = await compressImage(file, 4000, 0.95);
                    log(`Optimized to: ${(fileToUpload.size / 1024 / 1024).toFixed(2)} MB (Original Resolution Kept)`, 'success');
                } catch (e) {
                    log(`Optimization failed, trying original: ${e.message}`, 'error');
                }
            }

            // Upload 
            currentImageBlob = fileToUpload;
            await uploadImageDirectly(fileToUpload);
        });

        // High Quality Compression (Only if needed)
        async function compressImage(file, maxWidth = 4000, quality = 0.95) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Only resize if MASSIVE > 4000px (standard 4k limit)
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            if (!blob) reject(new Error('Canvas error'));
                            resolve(new File([blob], file.name.replace(/\.[^.]+$/, '.jpg'), { type: 'image/jpeg' }));
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = (e) => reject(e);
                };
                reader.onerror = (e) => reject(e);
            });
        }

        // UPLOAD (Tries Direct, Falls Back to Proxy)
        async function uploadImageDirectly(file) {
            const btn = document.getElementById('zoneA-btn');
            btn.disabled = true;
            btn.innerText = "Uploading... üöÄ";

            const fileExt = file.name.split('.').pop() || 'jpg';
            const filename = `playground/src-${Date.now()}.${fileExt}`;

            // --- ATTEMPT 1: Direct Upload (Fastest, Bypasses Limit) ---
            log('Trying direct CDN upload...');
            try {
                const authRes = await fetch(API_BASE + '/.netlify/functions/get-upload-url', {
                    method: 'POST',
                    body: JSON.stringify({ filename: filename })
                });

                if (!authRes.ok) throw new Error('Auth not available');
                const authData = await authRes.json();
                if (!authData.accessKey) throw new Error('No key provided');

                const uploadRes = await fetch(authData.uploadUrl, {
                    method: 'PUT',
                    headers: {
                        'AccessKey': authData.accessKey,
                        'Content-Type': 'application/octet-stream'
                    },
                    body: file
                });

                if (!uploadRes.ok) throw new Error('CDN PUT failed');

                generatedImageUrl = authData.cdnUrl;
                document.getElementById('zoneB-source-url').value = generatedImageUrl;
                log(`‚úÖ Direct Upload Success: ${generatedImageUrl}`, 'success');
                btn.innerText = "Generate Base Image üé®";
                btn.disabled = false;
                return; // Done!

            } catch (e) {
                log(`Direct upload unavailable (${e.message}). Falling back to proxy...`, 'warning');
            }

            // --- ATTEMPT 2: Proxy Upload (Works in Dev Mode) ---
            try {
                const toBase64 = f => new Promise((resolve, reject) => {
                    const r = new FileReader();
                    r.readAsDataURL(f);
                    r.onload = () => resolve(r.result);
                    r.onerror = e => reject(e);
                });

                const b64 = await toBase64(file);

                const res = await fetch(API_BASE + '/.netlify/functions/upload-user-image', {
                    method: 'POST',
                    body: JSON.stringify({ imageBase64: b64, filename: filename })
                });

                if (!res.ok) throw new Error('Proxy upload failed');
                const data = await res.json();

                generatedImageUrl = data.url;
                document.getElementById('zoneB-source-url').value = generatedImageUrl;
                log(`‚úÖ Proxy Upload Success: ${generatedImageUrl}`, 'success');
                btn.innerText = "Generate Base Image üé®";
                btn.disabled = false;

            } catch (e) {
                log(`Upload Error: ${e.message}`, 'error');
                btn.innerText = "Upload Failed ‚ùå";
                setTimeout(() => { btn.innerText = "Generate Base Image üé®"; btn.disabled = false; }, 3000);
            }
        }

        // INIT
        window.addEventListener('DOMContentLoaded', () => {
            updatePromptPreview();
            log('Playground v2.0 Initialized ‚ö°');
            log('9 GoT Templates loaded. Aspect Ratio: 9:16 (Social Media) default.', 'success');
        });

        // LOGGING SYSTEM
        function log(msg, type = 'info') {
            const el = document.getElementById('console-log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f55' : (type === 'success' ? '#5f5' : (type === 'warning' ? '#fa0' : '#0f0'));
            el.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        // --- ZONE A: IMAGE GEN ---

        function updatePromptPreview() {
            const tId = document.getElementById('zoneA-template').value;
            const promptBox = document.getElementById('zoneA-prompt-preview');
            // Populate with a starting point, but let user edit
            if (promptBox.value.startsWith('Select') || promptBox.value === "") {
                promptBox.value = TEMPLATE_PREVIEWS[tId] || "";
            } else {
                // Dont overwrite if user typed, unless they switch to custom? 
                // Simple logic: Just overwrite, user can Undo.
                promptBox.value = TEMPLATE_PREVIEWS[tId] || "";
            }
        }

        async function generateImage() {
            const customPrompt = document.getElementById('zoneA-prompt-preview').value;
            const aspectRatio = document.getElementById('zoneA-aspect-ratio').value;
            const btn = document.getElementById('zoneA-btn');

            if (!customPrompt || customPrompt.trim().length < 3) {
                log('Please enter a prompt (min 3 characters)!', 'error');
                return;
            }

            btn.disabled = true;

            // ============ IMAGEN 3 MODE (Text-to-Image) ============
            if (currentImageMode === 'imagen3') {
                const numImages = document.getElementById('zoneA-num-images').value;
                const cost = (0.03 * parseInt(numImages)).toFixed(2);

                btn.innerText = `Generating... (Imagen 3 - $${cost})`;
                log(`Starting Imagen 3 Gen... (${aspectRatio}, ${numImages} images, ~$${cost})`, 'warning');

                try {
                    const res = await fetch(API_BASE + '/.netlify/functions/api-image-imagen3', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: customPrompt,
                            aspectRatio: aspectRatio,
                            numberOfImages: parseInt(numImages)
                        })
                    });

                    const data = await res.json();
                    if (data.error) throw new Error(data.error + (data.details ? `: ${data.details}` : ''));

                    // Show all generated images
                    let imagesHtml = '';
                    if (data.images && data.images.length > 0) {
                        data.images.forEach((url, i) => {
                            imagesHtml += `<img src="${url}" style="max-width: ${100 / data.images.length}%; margin: 2px;">`;
                        });
                    }
                    document.getElementById('zoneA-result').innerHTML = imagesHtml || `<img src="${data.imageUrl}">`;

                    generatedImageUrl = data.imageUrl;
                    document.getElementById('zoneB-source-url').value = generatedImageUrl;

                    log(`‚úÖ Imagen 3 Generated ${data.images?.length || 1} image(s)! Cost: ${data.cost}`, 'success');

                } catch (e) {
                    log(`Imagen 3 Error: ${e.message}`, 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerText = "Generate with Imagen 3 ‚ú®";
                }
                return;
            }

            // ============ GEMINI MODE (Image-to-Image) ============
            if (!generatedImageUrl) {
                log('Please upload a reference image first!', 'error');
                btn.disabled = false;
                return;
            }

            const resolution = document.getElementById('zoneA-resolution').value;
            const safetyFilter = document.getElementById('zoneA-safety').value;

            btn.innerText = "Generating... (Gemini 3 Pro)";
            log(`Starting FREE Gemini Gen... (${aspectRatio}, ${resolution})`, 'info');

            try {
                const res = await fetch(API_BASE + '/.netlify/functions/api-image-gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: customPrompt,
                        imageUrl: generatedImageUrl,
                        aspectRatio: aspectRatio,
                        resolution: resolution,
                        safetyFilterLevel: safetyFilter
                    })
                });

                const data = await res.json();
                if (data.error) throw new Error(data.error + (data.details ? `: ${data.details}` : ''));

                const resultUrl = data.imageUrl;
                log(`‚úÖ Gemini Image Generated! Settings: ${JSON.stringify(data.settings)}`, 'success');

                document.getElementById('zoneA-result').innerHTML = `<img src="${resultUrl}">`;
                generatedImageUrl = resultUrl;
                document.getElementById('zoneB-source-url').value = generatedImageUrl;

                log('‚úÖ Ready for Video Generation!', 'success');

            } catch (e) {
                log(`Gemini Error: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerText = "Generate Base Image üé®";
            }
        }

        // --- ZONE B: VIDEO GEN ---

        function selectVeoModel(type) {
            document.getElementById('veo-model-val').value = type;
            document.getElementById('veo-opt-standard').classList.remove('selected');
            document.getElementById('veo-opt-fast').classList.remove('selected');
            document.getElementById(`veo-opt-${type}`).classList.add('selected');
            log(`Veo Model set to: ${type.toUpperCase()}`);
        }

        async function generateVideo(model) {
            const compiledPrompt = document.getElementById('zoneB-prompt').value;
            const sourceUrl = document.getElementById('zoneB-source-url').value;
            const veoModelType = document.getElementById('veo-model-val').value;

            if (!sourceUrl) { log('No source image for video!', 'error'); return; }

            const resultZone = document.getElementById('zoneB-result');
            resultZone.innerHTML = '<p class="status-working">Generating Video...</p>';

            log(`Starting Video Gen (${model.toUpperCase()})...`);

            try {
                if (model === 'kling') {
                    // Call Kling API
                    const res = await fetch(API_BASE + '/.netlify/functions/api-video-kling', {
                        method: 'POST',
                        body: JSON.stringify({
                            imageUrl: sourceUrl,
                            prompt: compiledPrompt
                        })
                    });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);

                    const predId = data.id;
                    log(`Kling Task: ${predId}`);

                    const videoUrl = await pollReplicate(predId);
                    resultZone.innerHTML = `<video src="${videoUrl}" controls autoplay loop></video>`;
                    log('‚úÖ Kling Video Ready!', 'success');

                } else if (model === 'veo') {
                    // Call Veo (Bunny Polling)
                    const jobId = `veo-${Date.now()}`;
                    const filename = `playground/veo-${Date.now()}.mp4`;

                    log(`Sending Veo Request (Model: ${veoModelType})...`);

                    const res = await fetch(API_BASE + '/.netlify/functions/generate-video-veo-background', {
                        method: 'POST',
                        body: JSON.stringify({
                            imageUrl: sourceUrl,
                            prompt: compiledPrompt,
                            jobId: jobId,
                            outputFilename: filename,
                            modelType: veoModelType // SEND MODEL SELECTION
                        })
                    });

                    log('Veo Request Sent. Waiting for render (may take 2 mins)...');

                    // Manual Polling for BunnyCDN file
                    const cdnUrl = `https://raincrest-cdn.b-cdn.net/${filename}`;
                    await pollUrl(cdnUrl);

                    resultZone.innerHTML = `<video src="${cdnUrl}" controls autoplay loop></video>`;
                    log('‚úÖ Veo Video Ready!', 'success');
                }

            } catch (e) {
                log(`Video Error: ${e.message}`, 'error');
                resultZone.innerHTML = `<p class="status-error">Failed: ${e.message}</p>`;
            }
        }


        // --- UTILS ---

        async function pollReplicate(id) {
            let attempts = 0;
            while (attempts < 60) {
                const res = await fetch(API_BASE + `/.netlify/functions/check-prediction-status?predictionId=${id}`);
                const data = await res.json();

                if (data.status === 'succeeded') return data.imageUrl;
                if (data.status === 'failed') throw new Error(data.error || 'Generation failed');

                await new Promise(r => setTimeout(r, 2000));
                attempts++;
            }
            throw new Error('Timeout');
        }

        async function pollUrl(url) {
            let attempts = 0;
            while (attempts < 120) { // 4 mins
                try {
                    const res = await fetch(url, { method: 'HEAD' });
                    if (res.ok) return url;
                } catch (e) { }
                await new Promise(r => setTimeout(r, 2000));
                attempts++;
            }
            throw new Error('Video generation timeout');
        }

        log('Playground Initialized ‚ö°');

    </script>
</body>

</html>